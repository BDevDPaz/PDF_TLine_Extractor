<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador PDF Inteligente v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; } </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <header class="text-center py-6">
            <h1 class="text-4xl font-bold text-gray-800">Analizador PDF Inteligente</h1>
            <p class="text-lg text-gray-600">Sigue el flujo de trabajo: Cargar -> Visualizar y Seleccionar -> Procesar -> Analizar</p>
        </header>

        <!-- SECCIÓN 1: Carga de Archivo -->
        <div id="upload-section" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="upload-cloud"></i>Paso 1: Cargar Archivo PDF</h2>
            <input type="file" id="pdf-input" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
            <div id="upload-status" class="mt-4"></div>
        </div>

        <!-- SECCIÓN 2: Visualizador y Procesamiento -->
        <div id="viewer-section" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="file-check-2"></i>Paso 2: Visualizar y Procesar</h2>
            <div id="viewer-controls" class="flex justify-between items-center mb-4">
                <button id="process-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 disabled:bg-gray-400">
                    <i data-lucide="cog"></i> <span id="process-button-text">Procesar Páginas Seleccionadas</span>
                </button>
                <div id="process-status"></div>
            </div>
            <div id="pdf-viewer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 border p-4 rounded-lg bg-gray-100">
                <!-- Las páginas del PDF se renderizarán aquí -->
            </div>
        </div>

        <!-- SECCIÓN 3: Análisis de Datos -->
        <div id="analysis-section" class="hidden bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3"></i>Paso 3: Analizar Datos</h2>
            <div class="flex border-b mb-4">
                <button id="tab-table" class="py-2 px-4 border-b-2 border-blue-500 font-semibold">Tabla de Datos</button>
                <button id="tab-charts" class="py-2 px-4 text-gray-500">Análisis Visual</button>
            </div>
            
            <div id="table-view">
                <div class="flex gap-4 mb-4">
                    <input type="text" id="quick-filter" placeholder="Búsqueda rápida..." class="w-full md:w-1/3 px-3 py-2 border rounded-md">
                    <button id="export-csv" class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700"><i data-lucide="download"></i>Exportar CSV</button>
                </div>
                <div id="data-grid" class="ag-theme-alpine" style="height: 600px; width: 100%;"></div>
            </div>

            <div id="charts-view" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                 <div class="h-96"><canvas id="callsChart"></canvas></div>
                 <div class="h-96"><canvas id="dataUsageChart"></canvas></div>
            </div>
        </div>
    </div>

<script>
    // --- Configuración e Inicialización ---
    pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js`;
    let currentFilename = null;
    let gridApi;

    const uploadInput = document.getElementById('pdf-input');
    const uploadStatus = document.getElementById('upload-status');
    const viewerSection = document.getElementById('viewer-section');
    const pdfViewer = document.getElementById('pdf-viewer');
    const processButton = document.getElementById('process-button');
    const processStatus = document.getElementById('process-status');
    const analysisSection = document.getElementById('analysis-section');
    
    // --- Lógica de la Interfaz ---
    uploadInput.addEventListener('change', handleFileUpload);
    processButton.addEventListener('click', handleProcess);
    document.getElementById('export-csv').addEventListener('click', () => window.location.href = '/api/export-csv');

    // Lógica de pestañas
    const tabTable = document.getElementById('tab-table');
    const tabCharts = document.getElementById('tab-charts');
    const tableView = document.getElementById('table-view');
    const chartsView = document.getElementById('charts-view');
    
    tabTable.addEventListener('click', () => {
        tableView.classList.remove('hidden');
        chartsView.classList.add('hidden');
        tabTable.classList.add('border-blue-500', 'font-semibold');
        tabCharts.classList.remove('border-blue-500', 'font-semibold');
        tabCharts.classList.add('text-gray-500');
        tabTable.classList.remove('text-gray-500');
    });
    tabCharts.addEventListener('click', () => {
        tableView.classList.add('hidden');
        chartsView.classList.remove('hidden');
        tabTable.classList.remove('border-blue-500', 'font-semibold');
        tabCharts.classList.add('border-blue-500', 'font-semibold');
        tabCharts.classList.remove('text-gray-500');
        tabTable.classList.add('text-gray-500');
    });

    // --- Funciones Principales ---
    async function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        setStatus(uploadStatus, 'Subiendo...', 'loading');
        const formData = new FormData();
        formData.append('pdfFile', file);

        try {
            const response = await fetch('/api/upload', { method: 'POST', body: formData });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            setStatus(uploadStatus, `✅ ${result.message}. Ahora selecciona las páginas a procesar.`, 'success');
            currentFilename = result.filename;
            viewerSection.classList.remove('hidden');
            renderPdf(result.filename);
        } catch (error) {
            setStatus(uploadStatus, `❌ ${error.message}`, 'error');
        }
    }

    async function renderPdf(filename) {
        pdfViewer.innerHTML = 'Cargando previsualización...';
        const url = `/uploads/${filename}`;
        const loadingTask = pdfjsLib.getDocument(url);
        const pdf = await loadingTask.promise;

        pdfViewer.innerHTML = '';
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 0.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = { canvasContext: context, viewport: viewport };
            await page.render(renderContext).promise;

            const pageDiv = document.createElement('div');
            pageDiv.className = 'border rounded-lg p-2 flex flex-col items-center gap-2';
            pageDiv.innerHTML = `
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" checked class="page-checkbox" data-page-num="${i}">
                    Página ${i}
                </label>
            `;
            pageDiv.prepend(canvas);
            pdfViewer.appendChild(pageDiv);
        }
    }

    async function handleProcess() {
        const selectedPages = Array.from(document.querySelectorAll('.page-checkbox:checked'))
                                 .map(cb => parseInt(cb.dataset.pageNum));
        
        if (selectedPages.length === 0) {
            setStatus(processStatus, 'Selecciona al menos una página.', 'error');
            return;
        }

        setStatus(processStatus, 'Procesando...', 'loading');
        document.getElementById('process-button-text').innerText = "Procesando...";
        processButton.disabled = true;

        try {
            const response = await fetch('/api/process', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename: currentFilename, pages: selectedPages })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);

            setStatus(processStatus, `✅ ${result.message}`, 'success');
            analysisSection.classList.remove('hidden');
            loadDataIntoGrid();
        } catch (error) {
            setStatus(processStatus, `❌ ${error.message}`, 'error');
        } finally {
            document.getElementById('process-button-text').innerText = "Procesar Páginas Seleccionadas";
            processButton.disabled = false;
        }
    }

    function initializeGrid() {
        const columnDefs = [
            { field: "event_type", headerName: "Tipo", filter: true, width: 120 },
            { field: "timestamp", headerName: "Fecha y Hora", sort: 'desc', width: 180 },
            { field: "detail_1", headerName: "Detalle Principal", filter: true },
            { field: "detail_2", headerName: "Detalle Secundario" },
            { field: "detail_3", headerName: "Detalle Adicional" },
            { field: "numeric_value", headerName: "Valor", filter: 'agNumberColumnFilter' },
            { field: "source_file", headerName: "Archivo Origen", filter: true },
        ];
        const gridOptions = {
            columnDefs: columnDefs,
            defaultColDef: { sortable: true, resizable: true },
            onGridReady: (params) => { gridApi = params.api; }
        };
        const gridDiv = document.getElementById('data-grid');
        agGrid.createGrid(gridDiv, gridOptions);
        document.getElementById('quick-filter').addEventListener('input', (e) => gridApi.setQuickFilter(e.target.value));
    }
    
    async function loadDataIntoGrid() {
        if (!gridApi) initializeGrid();
        const response = await fetch('/api/get-data');
        const data = await response.json();
        gridApi.setRowData(data);
        renderCharts(data);
    }

    // --- Gráficos y Utilidades ---
    let callsChart, dataUsageChart;
    function renderCharts(data) {
        // Lógica de Gráfico de Llamadas
        const callsData = data.filter(d => d.event_type === 'Llamada');
        const callsByNumber = callsData.reduce((acc, call) => {
            acc[call.detail_1] = (acc[call.detail_1] || 0) + 1;
            return acc;
        }, {});
        const sortedCalls = Object.entries(callsByNumber).sort((a, b) => b[1] - a[1]).slice(0, 10);
        
        if (callsChart) callsChart.destroy();
        callsChart = createBarChart('callsChart', 'Top 10 Llamadas por Número', sortedCalls.map(c => c[0]), sortedCalls.map(c => c[1]), '#3b82f6');
        
        // Lógica de Gráfico de Uso de Datos
        const dataUsage = data.filter(d => d.event_type === 'Datos');
        const dataByDay = dataUsage.reduce((acc, item) => {
            const day = new Date(item.timestamp).toLocaleDateString();
            acc[day] = (acc[day] || 0) + item.numeric_value;
            return acc;
        }, {});

        if (dataUsageChart) dataUsageChart.destroy();
        dataUsageChart = createBarChart('dataUsageChart', 'Uso de Datos (MB) por Día', Object.keys(dataByDay), Object.values(dataByDay), '#16a34a');
    }
    
    function createBarChart(canvasId, label, labels, data, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label, data, backgroundColor: color }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function setStatus(element, message, type) {
        element.innerHTML = message;
        element.className = 'mt-2 text-sm ';
        if (type === 'success') element.classList.add('text-green-600');
        else if (type === 'error') element.classList.add('text-red-600');
        else if (type === 'loading') element.classList.add('text-blue-600');
    }
    
    // --- Inicialización al Cargar la Página ---
    lucide.createIcons();
    initializeGrid();
</script>
</body>
</html>